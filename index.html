<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íœ´ê°€ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <div id="root"></div>

    <script>
        // ============================================
        // ì„¤ì •
        // ============================================
        const CLIENT_ID = '515092066469-v0lkn16jt7m8p8e3tqak7mo8s5irvto4.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDj6uiKHHHHZ1Z8EE2TxRq2o00LN6LAvvo';
        const CALENDAR_ID = 'c_5dd7e193b8547b937f07d753f828f11e74003961a6d30b2daf22243d7ba0afac@group.calendar.google.com';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzTQVLsxOpoeFMejhAu-I6OJm8idXiER2SDCrIesrVVTidkSeI5SV0hjHUMuo_7JNnQ/exec';

        // ============================================
        // ìƒíƒœ ê´€ë¦¬
        // ============================================
        let currentUser = null;
        let vacations = [];
        let gapiInited = false;
        let accessToken = null;

        // ============================================
        // Google Calendar API ì´ˆê¸°í™”
        // ============================================
        function initGAPI() {
            if (typeof gapi === 'undefined') {
                console.log('GAPI ë¡œë”© ëŒ€ê¸° ì¤‘...');
                setTimeout(initGAPI, 100);
                return;
            }
            
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
                });
                gapiInited = true;
                console.log('Google Calendar API ì´ˆê¸°í™” ì™„ë£Œ');
            });
        }

        // ============================================
        // Google ë¡œê·¸ì¸ ì²˜ë¦¬
        // ============================================
        function handleCredentialResponse(response) {
            console.log("Google ë¡œê·¸ì¸ ì„±ê³µ!");
            
            const payload = parseJwt(response.credential);
            console.log('ì‚¬ìš©ì ì •ë³´:', payload);
            
            currentUser = {
                email: payload.email,
                name: payload.name,
                picture: payload.picture,
                totalVacationDays: 15,
                isAdmin: payload.email === 'igwgukja@igodswill.org'
            };
            
            // ì•¡ì„¸ìŠ¤ í† í° ìš”ì²­ (Calendar APIìš©)
            requestCalendarAccess();
        }

        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
                '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
            ).join(''));
            return JSON.parse(jsonPayload);
        }

        function requestCalendarAccess() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/calendar.events',
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    gapi.client.setToken({access_token: accessToken});
                    console.log('Calendar ê¶Œí•œ íšë“ ì™„ë£Œ');
                    loadVacations();
                    renderMainScreen();
                }
            });
            client.requestAccessToken();
        }

        // ============================================
        // ë°ì´í„° ë¡œë“œ
        // ============================================
        async function loadVacations() {
            const stored = localStorage.getItem('vacations');
            vacations = stored ? JSON.parse(stored) : [];
        }

        function saveVacations() {
            localStorage.setItem('vacations', JSON.stringify(vacations));
        }

        // ============================================
        // Google Calendarì— ì´ë²¤íŠ¸ ì¶”ê°€
        // ============================================
        async function addToCalendar(vacation) {
            if (!gapiInited || !accessToken) {
                console.log('Calendar API ë¯¸ì¤€ë¹„');
                return null;
            }

            const event = {
                summary: `${vacation.userName} - ${vacation.type}`,
                description: `${vacation.userName}ë‹˜ì˜ íœ´ê°€`,
                start: vacation.type === 'ì—°ì°¨' ? 
                    { date: vacation.date } :
                    { dateTime: vacation.type === 'ì˜¤ì „ë°˜ì°¨' ? 
                        `${vacation.date}T09:00:00+09:00` :
                        `${vacation.date}T13:00:00+09:00`
                    },
                end: vacation.type === 'ì—°ì°¨' ?
                    { date: vacation.date } :
                    { dateTime: vacation.type === 'ì˜¤ì „ë°˜ì°¨' ?
                        `${vacation.date}T13:00:00+09:00` :
                        `${vacation.date}T18:00:00+09:00`
                    },
                colorId: '9'
            };

            try {
                const response = await gapi.client.calendar.events.insert({
                    calendarId: CALENDAR_ID,
                    resource: event
                });
                console.log('Calendar ì´ë²¤íŠ¸ ìƒì„±:', response.result.id);
                return response.result.id;
            } catch (error) {
                console.error('Calendar ì´ë²¤íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                return null;
            }
        }

        async function deleteFromCalendar(eventId) {
            if (!gapiInited || !accessToken || !eventId) return;

            try {
                await gapi.client.calendar.events.delete({
                    calendarId: CALENDAR_ID,
                    eventId: eventId
                });
                console.log('Calendar ì´ë²¤íŠ¸ ì‚­ì œ ì™„ë£Œ');
            } catch (error) {
                console.error('Calendar ì´ë²¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨:', error);
            }
        }

        // ============================================
        // íœ´ê°€ ì‹ ì²­
        // ============================================
        async function applyVacation(type, date, startDate, endDate) {
            const vacation = {
                id: Date.now().toString() + Math.random(),
                userId: currentUser.email,
                userName: currentUser.name,
                type: type,
                date: date,
                startDate: startDate,
                endDate: endDate,
                createdAt: new Date().toISOString(),
                googleEventId: null
            };

            const eventId = await addToCalendar(vacation);
            vacation.googleEventId = eventId;

            vacations.push(vacation);
            saveVacations();
            renderMainScreen();
        }

        async function deleteVacation(vacationId) {
            if (!currentUser.isAdmin) {
                alert('ê´€ë¦¬ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const vacation = vacations.find(v => v.id === vacationId);
            if (vacation && vacation.googleEventId) {
                await deleteFromCalendar(vacation.googleEventId);
            }

            vacations = vacations.filter(v => v.id !== vacationId);
            saveVacations();
            renderMainScreen();
        }

        async function deleteVacationGroup(ids) {
            if (!currentUser.isAdmin) {
                alert('ê´€ë¦¬ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            for (const id of ids) {
                const vacation = vacations.find(v => v.id === id);
                if (vacation && vacation.googleEventId) {
                    await deleteFromCalendar(vacation.googleEventId);
                }
            }

            vacations = vacations.filter(v => !ids.includes(v.id));
            saveVacations();
            renderMainScreen();
        }

        // ============================================
        // UI ë Œë”ë§
        // ============================================
        function renderLoginScreen() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <svg class="w-16 h-16 mx-auto text-indigo-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">íœ´ê°€ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                            <p class="text-gray-600">Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
                        </div>
                        <div id="googleSignInButton" class="flex justify-center"></div>
                    </div>
                </div>
            `;

            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("googleSignInButton"),
                { 
                    theme: "outline", 
                    size: "large", 
                    text: "signin_with", 
                    locale: "ko", 
                    width: 300
                }
            );
        }

        function renderMainScreen() {
            const myVacations = vacations.filter(v => v.userId === currentUser.email);
            const usedDays = myVacations.filter(v => v.type === 'ì—°ì°¨').length + 
                           myVacations.filter(v => v.type !== 'ì—°ì°¨').length * 0.5;
            const remainingDays = currentUser.totalVacationDays - usedDays;

            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-white shadow-md">
                        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-800">íœ´ê°€ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                                    <p class="text-sm text-gray-600">${currentUser.name} ${currentUser.isAdmin ? '(ê´€ë¦¬ì)' : ''}</p>
                                </div>
                            </div>
                            <button onclick="handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto px-4 py-8">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg p-6 text-white mb-6">
                            <h2 class="text-2xl font-bold mb-4">ë‚´ íœ´ê°€ í˜„í™©</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                                    <p class="text-sm opacity-90">ì´ íœ´ê°€</p>
                                    <p class="text-3xl font-bold">${currentUser.totalVacationDays}ì¼</p>
                                </div>
                                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                                    <p class="text-sm opacity-90">ì‚¬ìš©í•œ íœ´ê°€</p>
                                    <p class="text-3xl font-bold">${usedDays}ì¼</p>
                                </div>
                                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                                    <p class="text-sm opacity-90">ë‚¨ì€ íœ´ê°€</p>
                                    <p class="text-3xl font-bold">${remainingDays}ì¼</p>
                                </div>
                            </div>
                        </div>

                        <button onclick="showVacationModal()" class="w-full bg-indigo-600 text-white py-4 rounded-lg font-semibold hover:bg-indigo-700 mb-6">
                            + ìƒˆ íœ´ê°€ ì‹ ì²­
                        </button>

                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <h3 class="text-xl font-bold mb-4">ë‚´ íœ´ê°€ ëª©ë¡</h3>
                            ${myVacations.length === 0 ? 
                                '<p class="text-gray-500 text-center py-8">ì‹ ì²­í•œ íœ´ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>' :
                                (() => {
                                    // ì—°ì°¨ë¥¼ ê¸°ê°„ë³„ë¡œ ê·¸ë£¹í•‘
                                    const grouped = {};
                                    myVacations.forEach(v => {
                                        if (v.type === 'ì—°ì°¨' && v.startDate && v.endDate) {
                                            const key = `${v.startDate}_${v.endDate}`;
                                            if (!grouped[key]) {
                                                grouped[key] = {
                                                    type: v.type,
                                                    startDate: v.startDate,
                                                    endDate: v.endDate,
                                                    ids: []
                                                };
                                            }
                                            grouped[key].ids.push(v.id);
                                        } else {
                                            const key = v.id;
                                            grouped[key] = {
                                                type: v.type,
                                                date: v.date,
                                                ids: [v.id]
                                            };
                                        }
                                    });
                                    
                                    return Object.values(grouped).sort((a, b) => 
                                        new Date(b.startDate || b.date) - new Date(a.startDate || a.date)
                                    ).map(g => `
                                        <div class="flex justify-between items-center border-b py-3">
                                            <div>
                                                <span class="font-semibold">
                                                    ${g.startDate && g.endDate && g.startDate !== g.endDate ? 
                                                        `${g.startDate} ~ ${g.endDate}` : 
                                                        (g.date || g.startDate)
                                                    }
                                                </span>
                                                <span class="ml-3 px-3 py-1 rounded-full text-sm ${
                                                    g.type === 'ì—°ì°¨' ? 'bg-blue-100 text-blue-800' :
                                                    g.type === 'ì˜¤ì „ë°˜ì°¨' ? 'bg-green-100 text-green-800' :
                                                    'bg-yellow-100 text-yellow-800'
                                                }">${g.type}</span>
                                            </div>
                                            ${currentUser.isAdmin ? `
                                                <button onclick="deleteVacationGroup(${JSON.stringify(g.ids).replace(/"/g, '&quot;')})" class="text-red-600 hover:text-red-800">ì‚­ì œ</button>
                                            ` : ''}
                                        </div>
                                    `).join('');
                                })()
                            }
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-semibold text-blue-900 mb-1">ğŸ“… ê³µìš© Google Calendar</h3>
                                    <p class="text-sm text-blue-800">íŒ€ì›ë“¤ì˜ íœ´ê°€ ì¼ì •ì„ í™•ì¸í•˜ì„¸ìš”</p>
                                </div>
                                <a href="https://calendar.google.com/calendar/embed?src=${encodeURIComponent(CALENDAR_ID)}" 
                                   target="_blank"
                                   class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                                    ìº˜ë¦°ë” ì—´ê¸°
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-xl font-bold mb-4">íœ´ê°€ ì‹ ì²­</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">íœ´ê°€ ì¢…ë¥˜</label>
                                <select id="vacationType" onchange="toggleDateFields()" class="w-full border rounded-lg px-3 py-2">
                                    <option value="ì—°ì°¨">ì—°ì°¨</option>
                                    <option value="ì˜¤ì „ë°˜ì°¨">ì˜¤ì „ë°˜ì°¨</option>
                                    <option value="ì˜¤í›„ë°˜ì°¨">ì˜¤í›„ë°˜ì°¨</option>
                                </select>
                            </div>
                            <div id="singleDateField">
                                <label class="block text-sm font-medium mb-2">ì‹œì‘ì¼</label>
                                <input type="date" id="vacationStartDate" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div id="endDateField">
                                <label class="block text-sm font-medium mb-2">ì¢…ë£Œì¼</label>
                                <input type="date" id="vacationEndDate" class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="submitVacation()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">ì‹ ì²­</button>
                                <button onclick="hideVacationModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showVacationModal() {
            document.getElementById('modal').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('vacationStartDate').value = today;
            document.getElementById('vacationEndDate').value = today;
            toggleDateFields();
        }

        function toggleDateFields() {
            const type = document.getElementById('vacationType').value;
            const endDateField = document.getElementById('endDateField');
            
            if (type === 'ì—°ì°¨') {
                endDateField.style.display = 'block';
            } else {
                endDateField.style.display = 'none';
            }
        }

        function hideVacationModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function submitVacation() {
            const type = document.getElementById('vacationType').value;
            const startDate = document.getElementById('vacationStartDate').value;
            const endDate = type === 'ì—°ì°¨' ? document.getElementById('vacationEndDate').value : startDate;
            
            if (!startDate) {
                alert('ì‹œì‘ì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (type === 'ì—°ì°¨' && !endDate) {
                alert('ì¢…ë£Œì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (type === 'ì—°ì°¨' && new Date(endDate) < new Date(startDate)) {
                alert('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            // ì‹ ì²­í•˜ë ¤ëŠ” íœ´ê°€ ì¼ìˆ˜ ê³„ì‚°
            let requestDays = 0;
            if (type === 'ì—°ì°¨') {
                const start = new Date(startDate);
                const end = new Date(endDate);
                requestDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            } else {
                requestDays = 0.5; // ë°˜ì°¨
            }

            // í˜„ì¬ ì‚¬ìš©í•œ íœ´ê°€ ê³„ì‚°
            const myVacations = vacations.filter(v => v.userId === currentUser.email);
            const usedDays = myVacations.filter(v => v.type === 'ì—°ì°¨').length + 
                           myVacations.filter(v => v.type !== 'ì—°ì°¨').length * 0.5;
            
            // ë‚¨ì€ íœ´ê°€ í™•ì¸
            const remainingDays = currentUser.totalVacationDays - usedDays;

            if (requestDays > remainingDays) {
                if (remainingDays === 0) {
                    alert('íœ´ê°€ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.');
                } else {
                    alert(`ë‚¨ì€ íœ´ê°€ëŠ” ${remainingDays}ì¼ì…ë‹ˆë‹¤. ${requestDays}ì¼ì„ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }
                return;
            }

            hideVacationModal();
            
            if (type === 'ì—°ì°¨') {
                // ì—°ì°¨: ì‹œì‘ì¼ë¶€í„° ì¢…ë£Œì¼ê¹Œì§€ ëª¨ë“  ë‚ ì§œì— ì‹ ì²­
                const start = new Date(startDate);
                const end = new Date(endDate);
                const dates = [];
                
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    dates.push(dateStr);
                }
                
                // ê° ë‚ ì§œë§ˆë‹¤ íœ´ê°€ ì‹ ì²­
                dates.forEach(date => {
                    applyVacation(type, date, startDate, endDate);
                });
                
                alert(`${dates.length}ì¼ ì—°ì°¨ê°€ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } else {
                // ë°˜ì°¨: ë‹¨ì¼ ë‚ ì§œë§Œ ì‹ ì²­
                applyVacation(type, startDate, startDate, startDate);
                alert('ë°˜ì°¨ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        function handleLogout() {
            google.accounts.id.disableAutoSelect();
            currentUser = null;
            accessToken = null;
            renderLoginScreen();
        }

        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        window.onload = function() {
            console.log('íœ´ê°€ ê´€ë¦¬ ì‹œìŠ¤í…œ ì‹œì‘');
            initGAPI();
            renderLoginScreen();
        };
    </script>
</body>
</html>
